name: Continuous Deployment (az not azd)

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - feature/cd
      
permissions:
  id-token: write
  contents: read

jobs:
  continuous_deployment_with_az:
    runs-on: ubuntu-latest
    steps:              
      - name: Checkout Code
        uses: actions/checkout@v3
        
      - name: Setup Python 3.10 
        uses: actions/setup-python@v4
        with:
          python-version: "3.10.12"

      - name: Build frontend
        shell: bash
        run: |
          echo "intial contents of backend:"
          ls $GITHUB_WORKSPACE/5.internal-document-search/src/backend
          cd $GITHUB_WORKSPACE/5.internal-document-search/src/frontend
          git branch
          npm install
          npm run build
          echo "contents of backend after npm run build:"
          ls $GITHUB_WORKSPACE/5.internal-document-search/src/backend

      - name: 'Install dependencies'
        shell: bash
        run: |
          ls
          pwd
          cd 5.internal-document-search/src/backend
          git branch
          pwd
          ls
          which python
          python --version
          echo "---"
          pip install -r requirements.txt
       
      - name: "Az CLI login"
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          
      - name: 'Run Azure CLI commands'
        run: |
          az account show
          az group list
          pwd 
          ls
      - name: Zip the code
        run: |
          cd 5.internal-document-search/src/backend/
          zip -r myproject.zip .
          
      - name: Deploy to Azure Web App
        run: |
          az webapp deployment source config-zip --name ${{ vars.AZURE_WEBAPP_NAME }} --resource-group ${{ vars.AZURE_WEBAPP_RESOURCE_GROUP }} --src 5.internal-document-search/src/backend/myproject.zip
